<!DOCTYPE html>
<html>
	<head>
		<title>Tensorflow.js Demo</title>

		<meta charset="UTF-8" />
		<title>TensorFlow.js OBD Demo</title>
	</head>
	<body>
		<div class="server-side">
			<img
				id = "image"
				width = "320"
				height = "240"
			/>
			<canvas
				id = "canvas"
				style = "position: absolute; left: 0; top: 0;"
				width = "320"
				height = "240"
			></canvas>
		</div>
		<script src="/socket.io/socket.io.js"></script>
		<script>
			const socket = io();
			const imageElement = document.getElementById('image');
			const canvasElement = document.getElementById('canvas');
			const ctx = canvasElement.getContext('2d');

			const font = '24px helvetica';
			const activeColor = '#2fff00';
			const textColor = '#000000';
			ctx.font = font;
			ctx.textBaseline = 'top';
			ctx.strokeStyle = activeColor;
			ctx.lineWidth = 1;

			socket.on('image', function(data){
				imageElement.src = `data:image/jpeg;base64,${data}`;
			});

			socket.on('detected', function(detectedObjects) {
				ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
					detectedObjects.forEach(function(detected){
						const x = detected.bbox[0];
						const y = detected.bbox[1];
						const width = detected.bbox[2];
						const height = detected.bbox[3];
						// Draw the bounding box.
						ctx.strokeRect(x, y, width, height);

						// Draw the label background.
						ctx.fillStyle = activeColor;
						const textWidth = ctx.measureText(detected.class).width;
						const textHeight = parseInt(font, 10);
						// draw top left rectangle
						ctx.fillRect(x, y, textWidth + 10, textHeight + 10);
						// draw bottom left rectangle
						ctx.fillRect(x, y + height - textHeight, textWidth + 15, textHeight + 10);
						// Draw the text last to ensure it's on top.
						ctx.fillStyle = textColor;
						ctx.fillText(detected.class, x, y);
						ctx.fillText(detected.score.toFixed(2), x, y + height - textHeight);
					});
			})
		</script>
	</body>
</html>
